name: Monthly Python Script Execution

on:
  schedule:
    # 每个月2号的00:00 UTC运行脚本
    - cron: '0 0 2 * *'
  workflow_dispatch: # 也允许手动触发工作流

jobs:
  run_python_script:
    env:
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DASHBOARD_DB_HOST: ${{ secrets.DASHBOARD_DB_HOST }}
      DASHBOARD_DB_USER: ${{ secrets.DASHBOARD_DB_USER }}
      DASHBOARD_DB_PASSWORD: ${{ secrets.DASHBOARD_DB_PASSWORD }}

    runs-on: ubuntu-latest # 使用 GitHub 提供的 Ubuntu 环境

    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # 检出仓库代码
        if: ${{ env.DB_HOST && env.DB_USER && env.DB_PASSWORD && env.DASHBOARD_DB_HOST && env.DASHBOARD_DB_USER && env.DASHBOARD_DB_PASSWORD }}

      - name: Set up Python
        uses: actions/setup-python@v5
        if: ${{ env.DB_HOST && env.DB_USER && env.DB_PASSWORD && env.DASHBOARD_DB_HOST && env.DASHBOARD_DB_USER && env.DASHBOARD_DB_PASSWORD }}
        with:
          python-version: '3.10' # 设置 Python 版本

      - name: Install Python dependencies
        if: ${{ env.DB_HOST && env.DB_USER && env.DB_PASSWORD && env.DASHBOARD_DB_HOST && env.DASHBOARD_DB_USER && env.DASHBOARD_DB_PASSWORD }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt  # 安装 Python 依赖
      - name: Run the Python script
        if: ${{ env.DB_HOST && env.DB_USER && env.DB_PASSWORD && env.DASHBOARD_DB_HOST && env.DASHBOARD_DB_USER && env.DASHBOARD_DB_PASSWORD }}
        run: |
          python dashboard/company/scripts/workflow.py  # 执行 workflow.py 脚本
          python dashboard/repository/scripts/repo_name.py
          python dashboard/repository/scripts/repo_data.py
        env:
          xlabDB_HOST: ${{ env.DB_HOST }}
          xlabDB_USER: ${{ env.DB_USER }}
          xlabDB_PASSWORD: ${{ env.DB_PASSWORD }}
          dashboardDB_HOST: ${{ env.DASHBOARD_DB_HOST }}
          dashboardDB_USER: ${{ env.DASHBOARD_DB_USER }}
          dashboardDB_PASSWORD: ${{ env.DASHBOARD_DB_PASSWORD }}
